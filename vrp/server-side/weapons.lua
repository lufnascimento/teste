local weapons_list = {
    [453432689] = "WEAPON_PISTOL",
    [3219281620] = "WEAPON_PISTOL_MK2",
    [1593441988] = "WEAPON_COMBATPISTOL",
    [2578377531] = "WEAPON_PISTOL50",
    [3218215474] = "WEAPON_SNSPISTOL",
    [2285322324] = "WEAPON_SNSPISTOL_MK2",
    [3523564046] = "WEAPON_HEAVYPISTOL",
    [137902532] = "WEAPON_VINTAGEPISTOL",
    [3696079510] = "WEAPON_MARKSMANPISTOL",
    [3249783761] = "WEAPON_REVOLVER",
    [3415619887] = "WEAPON_REVOLVER_MK2",
    [2548703416] = "WEAPON_DOUBLEACTION",
    [584646201] = "WEAPON_APPISTOL",
    [911657153] = "WEAPON_STUNGUN",
    [1198879012] = "WEAPON_FLAREGUN",

    [324215364] = "WEAPON_MICROSMG",
    [3675956304] = "WEAPON_MACHINEPISTOL",
    [3173288789] = "WEAPON_MINISMG",
    [736523883] = "WEAPON_SMG",
    [2024373456] = "WEAPON_SMG_MK2",
    [4024951519] = "WEAPON_ASSAULTSMG",
    [171789620] = "WEAPON_COMBATPDW",
    [2634544996] = "WEAPON_MG",
    [2144741730] = "WEAPON_COMBATMG",
    [3686625920] = "WEAPON_COMBATMG_MK2",
    [1627465347] = "WEAPON_GUSENBERG",

    [3220176749] = "WEAPON_ASSAULTRIFLE",
    [961495388] = "WEAPON_ASSAULTRIFLE_MK2",
    [2210333304] = "WEAPON_CARBINERIFLE",
    [4208062921] = "WEAPON_CARBINERIFLE_MK2",
    [2937143193] = "WEAPON_ADVANCEDRIFLE",
    [3231910285] = "WEAPON_SPECIALCARBINE",
    [2526821735] = "WEAPON_SPECIALCARBINE_MK2",
    [2132975508] = "WEAPON_BULLPUPRIFLE",
    [2228681469] = "WEAPON_BULLPUPRIFLE_MK2",
    [1649403952] = "WEAPON_COMPACTRIFLE",

    [100416529] = "WEAPON_SNIPERRIFLE",
    [177293209] = "WEAPON_HEAVYSNIPER_MK2",
    [205991906] = "WEAPON_HEAVYSNIPER",
    [3342088282] = "WEAPON_MARKSMANRIFLE",
    [1785463520] = "WEAPON_MARKSMANRIFLE_MK2",

    [2578778090] = "WEAPON_KNIFE",
    [1737195953] = "WEAPON_NIGHTSTICK",
    [1317494643] = "WEAPON_HAMMER",
    [2508868239] = "WEAPON_BAT",
    [2227010557] = "WEAPON_CROWBAR",
    [1141786504] = "WEAPON_GOLFCLUB",
    [4192643659] = "WEAPON_BOTTLE",
    [2460120199] = "WEAPON_DAGGER",
    [4191993645] = "WEAPON_HATCHET",
    [3638508604] = "WEAPON_KNUCKLE",
    [3713923289] = "WEAPON_MACHETE",
    [2343591895] = "WEAPON_FLASHLIGHT",
    [3756226112] = "WEAPON_SWITCHBLADE",
    [3441901897] = "WEAPON_BATTLEAXE",
    [2484171525] = "WEAPON_POOLCUE",
    [419712736] = "WEAPON_WRENCH",

    [GetHashKey("WEAPON_PUMPSHOTGUN")] = "WEAPON_PUMPSHOTGUN",
    [1432025498] = "WEAPON_PUMPSHOTGUN_MK2",
    [2017895192] = "WEAPON_SAWNOFFSHOTGUN",
    [2640438543] = "WEAPON_BULLPUPSHOTGUN",
    [3800352039] = "WEAPON_ASSAULTSHOTGUN",
    [984333226] = "WEAPON_HEAVYSHOTGUN",
    [2828843422] = "WEAPON_MUSKET",
    [4019527611] = "WEAPON_DBSHOTGUN",
    [317205821] = "WEAPON_AUTOSHOTGUN",

    [2726580491] = "WEAPON_GRENADELAUNCHER",
    [2982836145] = "WEAPON_RPG",
    [1119849093] = "WEAPON_MINIGUN",
    [2138347493] = "WEAPON_FIREWORK",
    [1834241177] = "WEAPON_RAILGUN",
    [1672152130] = "WEAPON_HOMINGLAUNCHER",
    [125959754] = "WEAPON_COMPACTLAUNCHER",

    [2481070269] = "WEAPON_GRENADE",
    [741814745] = "WEAPON_STICKYBOMB",
    [2874559379] = "WEAPON_PROXMINE",
    [3125143736] = "WEAPON_PIPEBOMB",
    [4256991824] = "WEAPON_SMOKEGRENADE",
    [2694266206] = "WEAPON_BZGAS",
    [615608432] = "WEAPON_MOLOTOV",
    [101631238] = "WEAPON_FIREEXTINGUISHER",
    [883325847] = "WEAPON_PETROLCAN",
    [600439132] = "WEAPON_BALL",
    [126349499] = "WEAPON_SNOWBALL",

    [856002082] = "WEAPON_REMOTESNIPER",
    [4256881901] = "WEAPON_DIGISCANNER",
    [1305664598] = "WEAPON_GRENADELAUNCHER_SMOKE",
    [1752584910] = "WEAPON_STINGER",
    [3520460075] = "WEAPON_TACTICALRIFLE",
    [GetHashKey("WEAPON_TACTICALRIFLE")] = "WEAPON_TACTICALRIFLE",
    [GetHashKey("WEAPON_BULLPUPRIFLE")] = "WEAPON_BULLPUPRIFLE",
    [GetHashKey("WEAPON_AKPENTEDE90_RELIKIASHOP")] = "WEAPON_AKPENTEDE90_RELIKIASHOP",
    [GetHashKey("WEAPON_RAYCARBINE")] = "WEAPON_RAYCARBINE",
    [GetHashKey("WEAPON_RAYMINIGUN")] = "WEAPON_RAYMINIGUN",
    [GetHashKey("WEAPON_FLARE")] = "WEAPON_FLARE",
    [GetHashKey("WEAPON_HAZARDCAN")] = "WEAPON_HAZARDCAN",
    [GetHashKey("WEAPON_FERTILIZERCAN")] = "WEAPON_FERTILIZERCAN",
    [GetHashKey("WEAPON_HEAVYRIFLE")] = "WEAPON_HEAVYRIFLE",
    [GetHashKey("WEAPON_EMPLAUNCHER")] = "WEAPON_EMPLAUNCHER",
    [GetHashKey("WEAPON_PRECISIONRIFLE")] = "WEAPON_PRECISIONRIFLE",
    [GetHashKey("WEAPON_CERAMICPISTOL")] = "WEAPON_CERAMICPISTOL",
    [GetHashKey("WEAPON_NAVYREVOLVER")] = "WEAPON_NAVYREVOLVER",
    [4236992538] = "WEAPON_AR10PRETO_RELIKIASHOP",
    [GetHashKey("WEAPON_MILITARYRIFLE")] = "WEAPON_MILITARYRIFLE",
    [GetHashKey("WEAPON_AKDEFERRO_RELIKIASHOP")] = "WEAPON_AKDEFERRO_RELIKIASHOP",
    [GetHashKey("WEAPON_SPECIALCARBINE")] = "WEAPON_SPECIALCARBINE",
    [GetHashKey("WEAPON_AK472")] = "WEAPON_AK472",
    -- [GetHashKey("WEAPON_AR10PRETO_RELIKIASHOP")] = "WEAPON_AR10PRETO_RELIKIASHOP",
    [GetHashKey("WEAPON_AR15BEGE_RELIKIASHOP")] = "WEAPON_AR15BEGE_RELIKIASHOP",
    [GetHashKey("WEAPON_ARPENTEACRILICO_RELIKIASHOP")] = "WEAPON_ARPENTEACRILICO_RELIKIASHOP",
    [GetHashKey("WEAPON_ARDELUNETA_RELIKIASHOP")] = "WEAPON_ARDELUNETA_RELIKIASHOP",
    [GetHashKey("WEAPON_ARLUNETAPRATA")] = "WEAPON_ARLUNETAPRATA",
    [GetHashKey("WEAPON_ARTAMBOR")] = "WEAPON_ARTAMBOR",
    [GetHashKey("WEAPON_G3LUNETA_RELIKIASHOP")] = "WEAPON_G3LUNETA_RELIKIASHOP",
    [GetHashKey("WEAPON_GLOCKDEROUPA_RELIKIASHOP")] = "WEAPON_GLOCKDEROUPA_RELIKIASHOP",
    [GetHashKey("WEAPON_HKG3A3")] = "WEAPON_HKG3A3",
    [GetHashKey("WEAPON_HK_RELIKIASHOP")] = "WEAPON_HK_RELIKIASHOP",
    [GetHashKey("WEAPON_PENTEDUPLO1")] = "WEAPON_PENTEDUPLO1",
    [GetHashKey("WEAPON_50_RELIKIASHOP")] = "WEAPON_50_RELIKIASHOP",
    [GetHashKey("WEAPON_PARAFAL")] = "WEAPON_PARAFAL",
    [GetHashKey("GADGET_PARACHUTE")] = "GADGET_PARACHUTE",
    [GetHashKey("WEAPON_GRAJADA")] = "WEAPON_GRAJADA",
    [GetHashKey("WEAPON_BARRET")] = "WEAPON_BARRET",
    [711953949] = "vehicle_weapon_khanjali_mg", -- só pra dar ban insta;

    [GetHashKey("WEAPON_AKCROMO")] = "WEAPON_AKCROMO",
    [GetHashKey("WEAPON_ARRELIKIASHOPFEMININO1")] = "WEAPON_ARRELIKIASHOPFEMININO1",
    [GetHashKey("WEAPON_ARRELIKIASHOPFEMININO2")] = "WEAPON_ARRELIKIASHOPFEMININO2",
    [GetHashKey("WEAPON_ARVASCO")] = "WEAPON_ARVASCO",
    [GetHashKey("WEAPON_CHEYTAC")] = "WEAPON_CHEYTAC",
    [GetHashKey("WEAPON_G3RELIKIASHOPFEMININO")] = "WEAPON_G3RELIKIASHOPFEMININO",
    [GetHashKey("WEAPON_GLOCKRAJADA")] = "WEAPON_GLOCKRAJADA",
    [GetHashKey("WEAPON_GLOCKRELIKIASHOPFEMININO0")] = "WEAPON_GLOCKRELIKIASHOPFEMININO0",
}

local IGNORED_CAUSES = {
    [133987706] = true,
    [3452007600] = true,
    [1936677264] = true,
    [4194021054] = true,
    [2741846334] = true,
    [910830060] = true,
    [341774354] = true,
    [3750660587] = true,
}

local BLOCKED_WEAPONS = {
    [539292904] = true,
}

local usersIgnoreBucket = {}
AddEventHandler("zoneBucket:Toggle", function(src, status)
    usersIgnoreBucket[src] = status
end)
local _GetPlayerRoutingBucket = GetPlayerRoutingBucket
function GetPlayerRoutingBucket(src)
    if usersIgnoreBucket[src] then
        return 0
    end
    return _GetPlayerRoutingBucket(src)
end
CreateThread(function() 
    for k,v in pairs(weapons_list) do
        weapons_list[k & 0xFFFFFFFF] = v
    end
end)

function vRP.getWeapons(user_id)
    local data = vRP.user_tables[user_id] or {}
    return data.weapons
end

function vRP.updateAmmo(user_id, weaponsRaw, forcedRemoval)
    local source = vRP.getUserSource(user_id)
    local data = vRP.user_tables[user_id]
    if data then
        local weapons = data.weapons or {}
        for k,v in pairs(weaponsRaw) do
            if weapons[k] then
                if v.ammo > weapons[k].ammo then
                    if GetPlayerRoutingBucket(source) == 0 then
                        Citizen.Trace("\nSpawn de Municao: "..user_id.." - Arma: "..k.." [De "..weapons[k].ammo.." para: "..v.ammo.."]\n")
                        TriggerEvent("AC:ForceBan", vRP.getUserSource(user_id), {
                            reason = "MUNICAO_SPAWN_2",
                            additionalData = k.." ("..weapons[k].ammo.." => "..v.ammo..")",
                            forceBan = false
                        })
                    end
                end
                weapons[k].ammo = v.ammo
            else
                if not forcedRemoval[k] then
                    if GetPlayerRoutingBucket(source) == 0 then
                        print("Jogador Suspeito: "..user_id.." - Arma: "..k.." - Removida por não existir na lista de armas do jogador.")
                        TriggerEvent("AC:ForceBan", vRP.getUserSource(user_id), {
                            reason = "WEAPON_SPAWN_12",
                            additionalData = k,
                            forceBan = false
                        })
                    end
                else
                    Citizen.Trace("\nJogador Suspeitasso: "..user_id.." - Arma: "..k.."!\n")
                end
            end
        end
        data.weapons = weapons
        return true
    end
    return false
end

function vRP.addWeapon(user_id, weapon, ammo)
    local data = vRP.user_tables[user_id]
	if data and data.weapons then 
        data.weapons[weapon] = {ammo = ammo}
        return true
    end
    return false
end

function vRP.setWeapons(user_id, weapons)
    local data = vRP.user_tables[user_id]
	if data then data.weapons = weapons end
	if not next(weapons) then
		local source = vRP.getUserSource(user_id)
		vRPclient._replaceWeapons(source, {})
	end
	return data ~= nil
end


---TODO: Test with a player
local PlayersBypassed <const> = {}
local UNARMED = GetHashKey("WEAPON_UNARMED")
AddEventHandler("weaponDamageEvent", function(sender,ev)
    xpcall(function()
        local network_id = assert(ev.hitGlobalId,"network_id is nil")
        local entity = NetworkGetEntityFromNetworkId(network_id)
        if entity and IsPedAPlayer(entity) then
            local target_src = NetworkGetFirstEntityOwner(entity)
            if not target_src or target_src == sender then
                return
            end
            local weaponHash = ev.weaponType
            if BLOCKED_WEAPONS[weaponHash] then
                return CancelEvent()
            end
            local weapon = weapons_list[weaponHash]
            if not weapon then
                if weaponHash == UNARMED or weaponHash == 2725352035 then
                    if ev.weaponDamage > 1 then
                        TriggerEvent("AC:ForceBan", tonumber(sender), {
                            reason = "SUPER_SOCO_5",
                            forceBan = true
                        })
                    end
                    return CancelEvent()
                else
                    if not IGNORED_CAUSES[weaponHash] then
                        print("source => "..sender.." | hash not registered: "..json.encode({
                            weaponHash = weaponHash,
                            willKill = ev.willKill,
                            overrideDefaultDamage = ev.overrideDefaultDamage,
                            weaponDamage = ev.weaponDamage
                        }))
                        if ev.weaponDamage > 1 then
                            
                            if GetPlayerRoutingBucket(sender) == 5 then
                                return
                            end
                            TriggerEvent("AC:ForceBan", tonumber(sender), {
                                reason = "ILEGAL_DAMAGE",
                                forceBan = true,
                                additionalData = ""..weaponHash
                            })
                        end
                        return CancelEvent()
                    end
                end
                return
            end

            if GetPlayerRoutingBucket(sender) ~= 0 then
                return
            end

            local user_id = vRP.getUserId(tonumber(sender))
            if not user_id then
                print("ID BUGADO => SRC?", tonumber(sender))
                return CancelEvent()
            end
            if tonumber(vRP.getUserSource(user_id)) ~= tonumber(sender) then
                print("ID BUGADO => ", user_id,vRP.getUserSource(user_id), sender)
                return CancelEvent()
            end
            
            if user_id then
                local data = vRP.user_tables[user_id]
                if (data and data.weapons) and (not data.weapons[weapon]) then
              
                    if vRP.policeBlacklist[weapon] or weapon == "WEAPON_TACTICALRIFLE" then
                        if PlayersBypassed[user_id] then
                            return
                        end
                        local plyInPtr = vRP.checkPatrulhamento(user_id) or vRP.hasPermission(user_id,"perm.chamadoscivil") or vRP.hasPermission(user_id,"perm.cot") or vRP.hasPermission(user_id,"perm.countpolicia") or vRP.hasPermission("perm.got") or vRP.hasPermission("perm.choque") or vRP.hasPermission(user_id,"perm.prf")
                        if plyInPtr then
                            PlayersBypassed[user_id] = true
                            return
                        end
                    end
                    if #(GetEntityCoords(GetPlayerPed(sender)) - vec3(1679.1, 2514.55, 45.55)) < 25.0 then
                        return
                    end
                    RemoveAllPedWeapons(GetPlayerPed(sender), true)
                    print("[Disparo Efetuado] Jogador Suspeito: "..user_id.." - Arma: "..weapon.." - Removida por não existir na lista de armas do jogador.")
                    vRP.sendLog("https://discord.com/api/webhooks/1303127738361839686/HR-HmglD-rwm6h5sj8vCvyny7OzdU4dB9Y98aEJtWcMWLkHwMvIJtDFe5psTvvt_YkbP", "USER_ID: "..user_id.." | ARMA ILEGAL: "..weapon)
                    TriggerEvent("AC:ForceBan", tonumber(sender), {
                        reason = "WEAPON_SPAWN_10",
                        additionalData = tostring(weapon),
                        forceBan = false
                    })
                    return CancelEvent()
                end
            end

        end
    end,function(err)
        print(err)
    end)

end)

function vRP.clearWeapons(user_id)
	local source = vRP.getUserSource(user_id)
    local data = vRP.user_tables[user_id]
    if not data then
        return {}
    end

	local old = {}
    if not data.weapons then
        return {}
    end
    local user_weapons = vRPclient.getWeapons(source)
    
    for k,v in pairs(data.weapons) do
        if user_weapons[k] then
            old[k] = v
        end
    end
    for k,v in pairs(user_weapons) do
        if old[k] then
            old[k] = v
        else
            --print("Weapon not found: "..k, user_id)
        end
    end
    
    data.weapons = {}
	vRPclient._replaceWeapons(source, {})
	return old
end

